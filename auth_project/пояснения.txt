
Безопасное хранение паролей: Используется password_hash() с алгоритмом по умолчанию (bcrypt)

Верификация паролей: Используется password_verify() для безопасной проверки

Защита от XSS: Все пользовательские данные выводятся через функцию escape()

Управление сессиями: Сессии используются для отслеживания состояния входа

Адаптивный дизайн: Сайт корректно отображается на всех устройствах

Визуальная обратная связь: Информативные сообщения об ошибках и успешных операциях



Открываем: http://localhost/auth_project/index.php

Стили оформления (style.css)
Выход из системы (logout.php)
Защищенная страница (dashboard.php)
Страница входа (login.php)
Страница регистрации (register.php)
Главная страница (index.php)
Конфигурация и функции (config.php)


auth_project/
│
├── index.php              # Главная страница
├── register.php           # Страница регистрации
├── login.php              # Страница входа
├── logout.php             # Выход из системы
├── dashboard.php          # Защищенная страница
├── config.php             # Конфигурация и функции
├── style.css              # Стили для оформления
└── users.txt              # Файл для хранения пользователей (аналог БД)

Основные компоненты:
config.php - ядро системы, содержит все функции безопасности
users.txt - файловая "база данных" для хранения пользователей
index.php - главная страница (публичная)
register.php - регистрация новых пользователей
login.php - аутентификация существующих пользователей
dashboard.php - защищенная страница (только для авторизованных)
logout.php - завершение сессии
style.css - стили оформления



1. Подробный разбор config.php
Запуск сессии

session_start();
session_start() инициализирует сессию PHP

Сессия позволяет хранить данные пользователя между запросами
Создает уникальный идентификатор сессии (session_id)
Безопасно хранит данные на сервере, а не в браузере пользователя



Хранение пользователей в файле:

define('USERS_FILE', 'users.txt');

Вместо реальной базы данных используем текстовый файл для простоты
Каждая строка содержит: username:hashed_password
В реальном проекте следует использовать MySQL/PostgreSQL


Функция регистрации

function registerUser($username, $password) {
    if (userExists($username)) {
        return ['success' => false, 'message' => 'Пользователь уже существует'];
    }
    
    $hashedPassword = password_hash($password, PASSWORD_DEFAULT);
    $userData = $username . ':' . $hashedPassword . PHP_EOL;
    
    if (file_put_contents(USERS_FILE, $userData, FILE_APPEND | LOCK_EX) !== false) {
        return ['success' => true, 'message' => 'Регистрация успешна!'];
    }
}


Ключевые моменты:

userExists($username) - проверяет, не занято ли имя
password_hash($password, PASSWORD_DEFAULT) - главная функция безопасности

Автоматически выбирает самый безопасный алгоритм (сейчас bcrypt)
Добавляет "соль" (salt) автоматически
Возвращает строку формата: $алгоритм$стоимость$соль$хеш

FILE_APPEND | LOCK_EX - флаги для безопасной записи:
FILE_APPEND - добавляет в конец файла
LOCK_EX - эксклюзивная блокировка файла на время записи

Функция проверки пароля:

function loginUser($username, $password) {
    $users = file(USERS_FILE, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    
    foreach ($users as $user) {
        list($storedUsername, $storedHash) = explode(':', $user, 2);
        
        if ($storedUsername === $username) {
            if (password_verify($password, $storedHash)) {
                $_SESSION['user'] = $username;
                $_SESSION['login_time'] = time();
                return true;
            }
            break;
        }
    }
    return false;
}


Важные детали:

password_verify($password, $storedHash) - вторая главная функция безопасности

Сравнивает введенный пароль с хранящимся хешем
Автоматически определяет алгоритм и соль из хеша
Защищена от timing-атак (время проверки не зависит от успешности)

$_SESSION['user'] = $username - сохраняем имя пользователя в сессии
$_SESSION['login_time'] = time() - запоминаем время входа для отображения в ЛК

Почему password_hash() безопаснее md5() или sha1()?

Функция	            Соль	Стоимость	Адаптивность	Рекомендация
md5()	            Нет	        Нет	        Нет	        НЕ ИСПОЛЬЗОВАТЬ
sha1()	            Нет	        Нет	        Нет	        НЕ ИСПОЛЬЗОВАТЬ
password_hash()	    Авто	Да	        Да	        РЕКОМЕНДУЕТСЯ


Особенности password_hash():

Автоматическая соль - каждый хеш уникален, даже для одинаковых паролей
Адаптивная стоимость - можно настраивать сложность вычислений
Защита от перебора - вычисление одного хеша занимает ~0.1 секунды
Будущая совместимость - алгоритм можно менять без изменения кода

Функция защиты от XSS:

function escape($string) {
    return htmlspecialchars($string, ENT_QUOTES, 'UTF-8');
}

Что защищает:
Преобразует < в &lt;
Преобразует > в &gt;
Преобразует " в &quot;
Преобразует ' в &#039;
Защищает от вставки вредоносного JavaScript







2. Регистрация (register.php)
Валидация данных

if (empty($username) || empty($password)) {
    $message = 'Все поля обязательны';
} elseif (strlen($username) < 3) {
    $message = 'Имя должно быть от 3 символов';
} elseif (strlen($password) < 6) {
    $message = 'Пароль должен быть от 6 символов';
} elseif ($password !== $confirm_password) {
    $message = 'Пароли не совпадают';
}


Правила валидации:
Все поля обязательны
Имя пользователя минимум 3 символа
Пароль минимум 6 символов
Пароль и подтверждение должны совпадать

Безопасность формы

<input type="password" id="password" name="password" required minlength="6">
type="password" - скрывает ввод символов

required - обязательное поле (валидация на стороне браузера)
minlength="6" - минимальная длина (валидация на стороне браузера)



3. Вход в систему (login.php)

Защита от прямого доступа

if (isLoggedIn()) {
    header('Location: index.php');
    exit;
}

Если пользователь уже вошел, перенаправляем на главную
exit обязателен после header() для прекращения выполнения скрипта

Процесс аутентификации

if (loginUser($username, $password)) {
    header('Location: index.php');
    exit;
} else {
    $message = 'Неверное имя пользователя или пароль';
}

Важно: Мы не говорим, что именно неверно (имя или пароль), чтобы не помогать злоумышленникам.



4. Защищенная страница (dashboard.php)

Проверка авторизации

if (!isLoggedIn()) {
    header('Location: login.php');
    exit;
}

Защита от неавторизованного доступа
Редирект на страницу входа

Отображение информации о сессии

$loginTime = $_SESSION['login_time'];
$sessionDuration = time() - $loginTime;

Показываем пользователю, когда он вошел
Показываем, сколько длится сессия
Улучшает пользовательский опыт


6. Выход из системы (logout.php)

Безопасное завершение сессии

function logout() {
    session_unset();    // Удаляем все переменные сессии
    session_destroy();  // Уничтожаем сессию
}

Почему нужно делать и unset, и destroy?
session_unset() - очищает данные сессии в текущем скрипте
session_destroy() - удаляет сессию на сервере
Комбинация гарантирует полный выход



7. Безопасность сессий

Как работает сессия PHP:

Пользователь → Браузер → Cookie (session_id) → Сервер → Файл сессии

Защитные механизмы:
Session ID - случайная строка (32 символа)

Хранение на сервере - данные не передаются клиенту
Время жизни - сессия автоматически завершается через 24 минуты неактивности

8. Уязвимости и их предотвращение

SQL-инъекции - не актуально в нашем проекте
Мы используем файл, а не БД
В реальном проекте нужно использовать prepared statements


XSS (межсайтовый скриптинг)

echo escape($username);  // Вместо echo $username;
Всегда экранируем вывод пользовательских данных

CSRF (межсайтовая подделка запроса)

В нашем проекте не реализована защита
В реальном проекте нужны CSRF-токены

Сессионный захват

PHP автоматически генерирует сложные session_id
Для большей безопасности можно использовать session_regenerate_id()

Рекомендации для улучшения

Для учебного проекта:

Добавить подтверждение email
Реализовать "Запомнить меня"
Добавить капчу при регистрации
Валидировать email-адрес

Для production:

Использовать базу данных (MySQL/PostgreSQL)
Реализовать сброс пароля
Добавить двухфакторную аутентификацию
Внедрить ограничение попыток входа
Использовать HTTPS
Реализовать CSRF-токены

10. Демонстрация работы функций безопасности

Пример работы password_hash():

$password = "mypassword123";
$hash1 = password_hash($password, PASSWORD_DEFAULT);
Результат: $2y$10$s8S5pF5sD9f8hG7jH6kL3u9w2E4rT6yU7i8O0p...

$hash2 = password_hash($password, PASSWORD_DEFAULT);
Результат: $2y$10$d9H5jK8lS2f4G6hJ7kL9m1n3P5rT7yU8i0O...
Хеши РАЗНЫЕ, хотя пароль ОДИН И ТОТ ЖЕ!

Проверка:
password_verify("mypassword123", $hash1); // true
password_verify("mypassword123", $hash2); // true
password_verify("wrongpassword", $hash1); // false